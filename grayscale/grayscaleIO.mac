	;
	;	Grayscale Image Viewer for MK 90
	;	Alexander Zakharyan
	;	2019
	;
		
	.ENABL AMA
	.ASECT
	.RADIX 10

	.= 0

	PRINTATTRS = ^O34072
	PRINTNUM = ^O153360 
	PRINT = ^O153414 
	INITRAM = ^O153700
	INITTTY = ^O120536
	LCDINA = ^O164000
	LCDINB = ^O164002
	WAITCOMM = ^O174506
	SMPCMD = ^O164026
	SMPBAUD = ^O164022
	SMPCS = ^O164024
	SMPIO = ^O164020
	GETCH = ^O131120
	PUTCH = ^O116542
	RTCSEC = ^O165000
	RTCMIN = ^O165004

	nop
	br loader

	.= 32
loader:
	mov	#screen1, @#LCDINA
	mov #^B1000001011000110, @#LCDINB	;104Hz
	

	;Loader copyed from Game of Life app of Piotr Piatek
	; specify the SMP address
	mtps #^O340		;disable interrupts
	bis	#8, r5		;writing to the SMP
change:
	mov	r5,(r1)
	mov	#1245, @#change
	mov	#^O240, @#SMPCMD	;Write Address
	jsr	pc,(r2)
	mov #start/256, @#SMPIO	;high address byte
	jsr	pc,(r2)
	mov #start, @#SMPIO	;high address byte
	jsr	pc, (r2)
	tst	@#SMPCMD
	jsr	pc, (r2)
	; load data
	mov	#END-START, r4		;number of bytes
	mov	#START, r3
	mov	#^O320, @#SMPCMD	;Read Postincrement
	jsr	pc, (r2)
	bic	#8, r5		;reading from the SMP
	mov	r5, (r1)
	jsr	pc, (r2)
nxtb:	
	movb @#SMPIO, (r3)+	;read data byte from the SMP to the RAM
	jsr	pc, (r2)
	sob	r4, nxtb		;next data byte
	tst	@#SMPCMD
	jsr	pc, (r2)
	; start the loaded program
	mov	#^O340, -(sp)	;user mode, interrupts disabled
	;mov	#^O000, -(sp)	;user mode, interrupts enable
	mov	#start, -(sp)
	rti


	.= 512

START:
	mov #^B11111100, @#SMPCS	;select unused 4 device

	mov #screen1, r0
	mov #960, r1
	mov #screen1, r2
	mov #screen4, r3

	mov #488, @#SMPBAUD	;set freq devider = 800000/16/104 + some factor, leveling command execution time
	tst	@#SMPCMD

main:
	;delay
	clrb @#SMPCMD
waitSend:
	tstb @#SMPCS
	bpl waitSend
	tst	@#SMPCMD

	mov r0, @#LCDINA
	add r1, r0
	cmp r0, r3
	ble main
	mov r2,  r0

	br main

screen1:
	.word 1, 0, 7168, 7168, 1792, 57344, 0, 0, 0, 0, 3840, 3840, 15, 240, 0, 
	.word 0, 128, 29696, 15872, 25344, 49152, 0, 0, 0, 0, 3840, 3840, 15, 240, 0, 
	.word 0, 128, 5120, 32512, 58112, 49152, 32768, 0, 0, 0, 3328, 3584, 31, 240, 0, 
	.word 1, 64, 1536, 32512, 57600, 33024, 32768, 0, 192, 0, 7936, 36352, 31, 224, 0, 
	.word 0, 384, 6144, 16128, 16384, 33536, 32768, 3, 192, 0, 7680, 36352, 63, 224, 0, 
	.word 0, 128, 12288, 15872, 768, 768, 4, 13, 128, 0, 7936, 36352, 127, 192, 0, 
	.word 0, 128, 4096, 16128, 512, 1792, 60, 69, 0, 0, 15616, 33792, 255, 192, 0, 
	.word 0, 640, 8192, 15872, 3584, 3841, 184, 136, 0, 0, 16128, 33793, 255, 128, 0, 
	.word 0, 384, 9216, 7936, 39936, 3842, 243, 16, 0, 0, 32512, 33795, 255, 128, 0, 
	.word 0, 32896, 0, 6400, 38912, 7951, 187, 160, 0, 0, 32000, 32775, 255, 0, 0, 
	.word 0, 33664, 52224, 6400, 32768, 16151, 190, 128, 0, 0, 65280, 49183, 255, 0, 0, 
	.word 0, 33472, 7168, 2304, 32768, 32343, 191, 128, 0, 0, 64256, 49215, 254, 0, 0, 
	.word 1, 16960, 7168, 768, 32768, 32631, 191, 192, 0, 0, 64816, 49215, 254, 0, 0, 
	.word 0, 640, 32512, 512, 0, 65403, 143, 0, 0, 256, 64280, 49279, 252, 0, 0, 
	.word 0, 32896, 63744, 0, 259, 49150, 206, 0, 0, 256, 64796, 49279, 252, 0, 0, 
	.word 0, 576, 61440, 32768, 771, 65535, 12, 0, 0, 768, 64268, 16511, 252, 0, 0, 
	.word 1, 832, 61440, 0, 782, 65535, 32776, 0, 0, 768, 64796, 49215, 248, 0, 0, 
	.word 0, 640, 53248, 0, 1807, 65535, 41056, 0, 0, 1792, 62734, 57471, 248, 0, 0, 
	.word 0, 33920, 49152, 0, 3903, 65535, 49312, 0, 0, 3840, 64782, 16447, 248, 0, 0, 
	.word 0, 33856, 61440, 0, 8023, 65407, 57568, 0, 0, 3840, 62734, 57407, 240, 0, 0, 
	.word 0, 1408, 61440, 0, 7991, 65534, 61632, 0, 0, 7936, 62734, 16447, 240, 0, 0, 
	.word 0, 36672, 45056, 32, 16295, 65530, 62592, 0, 0, 7936, 61967, 49215, 224, 0, 0, 
	.word 0, 19328, 61440, 33, 32611, 65533, 65024, 0, 0, 16128, 61958, 41023, 224, 0, 0, 
	.word 0, 40768, 62208, 3, 65371, 65535, 64256, 32770, 0, 16128, 61743, 32831, 224, 0, 0, 
	.word 0, 3968, 61440, 8, 16142, 65486, 64000, 124, 64, 7938, 62847, 16415, 224, 0, 0, 
	.word 0, 3968, 61440, 59, 8094, 65534, 65024, 108, 0, 1798, 62270, 16415, 192, 0, 0, 
	.word 0, 3840, 63488, 47, 3870, 65534, 63488, 32, 0, 0, 62783, 49183, 192, 0, 0, 
	.word 0, 8064, 55296, 237, 1823, 65528, 64512, 0, 0, 0, 31295, 16415, 192, 0, 0, 
	.word 0, 7680, 52224, 8, 1807, 65528, 64512, 0, 0, 0, 5951, 49183, 128, 0, 0, 
	.word 0, 7168, 5127, 28, 783, 65520, 60416, 0, 0, 0, 2847, 31, 128, 0, 256, 
	.word 0, 15360, 4671, 8204, 783, 65520, 58880, 0, 0, 0, 1807, 49183, 128, 0, 768, 
	.word 0, 16128, 65038, 28700, 271, 65504, 58368, 0, 0, 0, 783, 49183, 0, 0, 512, 

screen2:
	.word 257, 61695, 16376, 65282, 57088, 57344, 24576, 0, 0, 0, 7936, 40704, 32783, 248, 0, 
	.word 259, 61951, 65496, 65282, 63232, 57344, 57344, 0, 0, 0, 16128, 40705, 143, 240, 0, 
	.word 257, 61438, 65272, 65280, 64272, 57600, 57368, 0, 16, 0, 7936, 40710, 31, 240, 0, 
	.word 259, 61695, 65496, 65282, 61824, 49408, 57404, 63, 240, 0, 16128, 40716, 63, 224, 0, 
	.word 257, 54270, 65272, 65282, 58752, 49920, 57566, 255, 192, 0, 16128, 36472, 63, 224, 0, 
	.word 259, 52223, 65464, 32512, 59266, 34564, 57535, 255, 128, 0, 16129, 36576, 255, 192, 0, 
	.word 257, 60415, 65516, 32513, 40712, 34691, 57599, 255, 0, 0, 32514, 52737, 255, 192, 0, 
	.word 259, 57341, 65532, 32514, 24064, 3851, 57599, 254, 0, 0, 32540, 52227, 255, 192, 0, 
	.word 3, 63487, 65388, 24320, 56884, 7983, 57599, 252, 512, 0, 32612, 52231, 255, 128, 0, 
	.word 257, 65535, 65530, 16130, 65029, 16191, 57599, 232, 0, 0, 65524, 52239, 255, 128, 0, 
	.word 1, 63487, 65388, 39168, 62144, 16383, 49407, 240, 0, 0, 65400, 52255, 255, 128, 0, 
	.word 1, 62463, 65527, 57089, 49684, 32767, 57599, 240, 0, 256, 65324, 49279, 255, 128, 0, 
	.word 257, 61439, 65365, 57093, 50243, 65535, 53503, 240, 0, 256, 65340, 57471, 255, 0, 0, 
	.word 257, 59387, 65530, 58881, 1355, 65535, 57599, 192, 0, 768, 65342, 57471, 255, 0, 0, 
	.word 1, 57343, 65450, 62474, 431, 65535, 57599, 0, 0, 768, 65342, 57471, 254, 0, 0, 
	.word 257, 47103, 65523, 64522, 4927, 65535, 61694, 0, 32768, 1792, 65310, 57471, 254, 0, 0, 
	.word 1, 26619, 64324, 63626, 1855, 65535, 61676, 0, 0, 1792, 65310, 57471, 252, 0, 0, 
	.word 1, 61439, 64500, 63626, 1919, 65535, 63736, 0, 0, 3840, 65310, 57471, 252, 0, 0, 
	.word 1, 57339, 63829, 53248, 4095, 65535, 64752, 0, 0, 3840, 65311, 57471, 248, 0, 0, 
	.word 257, 57343, 62193, 59394, 8191, 65535, 65512, 0, 0, 7936, 65295, 57471, 248, 0, 0, 
	.word 3, 65531, 61524, 62977, 16383, 65535, 65248, 32770, 0, 16128, 65311, 57407, 248, 512, 0, 
	.word 257, 65535, 63188, 29299, 32767, 65535, 65472, 32768, 224, 16128, 65343, 57407, 240, 0, 0, 
	.word 1, 65533, 65512, 13111, 32767, 65535, 65408, 32768, 88, 16129, 65535, 57407, 240, 0, 0, 
	.word 257, 65534, 64480, 49423, 65535, 65535, 65408, 61503, 192, 32513, 65535, 57407, 240, 1024, 0, 
	.word 1, 40959, 64448, 59455, 32767, 65535, 65280, 57470, 224, 16135, 65535, 58687, 224, 0, 0, 
	.word 1, 12278, 63936, 61823, 16383, 65534, 65281, 254, 48, 1807, 65407, 58687, 62688, 5120, 0, 
	.word 1, 32767, 64960, 52607, 40959, 65534, 65281, 124, 16, 270, 65343, 57407, 12224, 60416, 0, 
	.word 1, 57338, 64961, 40959, 4063, 65534, 65280, 32800, 0, 0, 32639, 57407, 12224, 64512, 0, 
	.word 1, 49131, 65155, 56575, 10207, 65532, 65280, 0, 0, 0, 16383, 57535, 960, 58368, 256, 
	.word 1, 16377, 65287, 65151, 22527, 65528, 65280, 16384, 0, 0, 4095, 57503, 448, 25600, 768, 
	.word 1, 32744, 32575, 64703, 991, 65528, 65296, 0, 0, 0, 1855, 49183, 128, 40960, 768, 
	.word 1, 32748, 65343, 65279, 41823, 65520, 65312, 32768, 0, 0, 1855, 49311, 128, 8192, 1792, 

screen3:	
	.word 807, 65535, 65528, 65407, 65535, 63602, 64686, 132, 5888, 768, 65280, 48901, 58767, 22526, 61525, 
	.word 775, 65535, 65528, 65311, 65535, 63741, 65399, 210, 6996, 256, 65280, 65287, 60063, 48639, 28746, 
	.word 791, 65535, 65528, 65303, 65533, 61951, 65022, 255, 12280, 768, 65280, 48911, 58783, 45053, 57386, 
	.word 775, 65535, 65528, 65311, 65535, 58359, 65279, 33023, 6128, 33024, 65280, 65343, 59967, 46591, 57429, 
	.word 775, 65535, 65528, 65343, 65535, 58367, 65279, 33023, 32752, 1792, 65280, 57340, 51839, 57336, 49226, 
	.word 775, 65535, 65532, 65343, 63487, 59391, 65535, 16639, 16320, 33024, 65283, 65528, 60415, 22013, 49189, 
	.word 779, 65535, 65532, 65311, 65535, 61439, 65279, 43263, 49088, 1792, 65295, 57281, 11007, 65530, 32938, 
	.word 775, 65535, 65532, 65295, 65535, 8191, 65535, 42239, 30592, 34560, 65343, 65283, 55039, 44024, 32805, 
	.word 779, 65535, 65534, 65287, 65279, 8191, 65279, 37630, 48896, 50944, 65534, 57159, 11263, 32757, 82, 
	.word 775, 65535, 65534, 65295, 65535, 16383, 65535, 43262, 24320, 34560, 65535, 65311, 46591, 44024, 9, 
	.word 775, 65535, 65535, 65287, 64511, 32767, 65535, 54782, 5120, 2816, 65535, 60991, 22271, 65522, 170, 
	.word 775, 65535, 65535, 65295, 63487, 32767, 65535, 21756, 20480, 3840, 65407, 65535, 23551, 22513, 2, 
	.word 775, 65535, 65535, 65415, 51199, 65535, 65279, 54776, 20480, 3840, 65407, 65279, 44543, 65512, 181, 
	.word 775, 65535, 65535, 65423, 52735, 65535, 65535, 30704, 43008, 3840, 65407, 65535, 22015, 22506, 16, 
	.word 775, 65535, 65535, 65423, 8191, 65535, 65535, 57288, 65280, 32512, 65407, 65023, 24575, 65525, 171, 
	.word 775, 65535, 65535, 65423, 8191, 65535, 65535, 55176, 65280, 65280, 65343, 60927, 21247, 43934, 168, 
	.word 775, 65535, 65535, 65423, 14335, 65535, 65534, 61184, 61472, 32512, 65343, 62975, 23551, 65189, 255, 
	.word 775, 65535, 65535, 65487, 32767, 65535, 65534, 60168, 64000, 32512, 65343, 62975, 22015, 24210, 11, 
	.word 263, 65535, 65535, 65279, 8191, 65535, 65534, 64256, 65408, 48896, 65311, 62847, 27647, 65321, 127, 
	.word 775, 65535, 65535, 65535, 16383, 65535, 65528, 64770, 65280, 65280, 65311, 63231, 46335, 48778, 37, 
	.word 771, 65535, 65535, 65151, 16383, 65535, 65528, 65031, 32960, 32512, 65343, 62079, 45054, 65386, 173, 
	.word 775, 65535, 65535, 65403, 32767, 65535, 65520, 62991, 33008, 65280, 65535, 64511, 30207, 32277, 85, 
	.word 771, 65535, 65535, 65535, 65535, 65535, 65504, 64830, 504, 32515, 65535, 62975, 47102, 65237, 85, 
	.word 775, 65535, 65534, 65471, 65535, 65535, 65472, 65407, 49660, 65287, 65535, 63487, 65022, 32298, 173, 
	.word 775, 65535, 65525, 65407, 65535, 65535, 65408, 65535, 10750, 32527, 65535, 63487, 65533, 65194, 171, 
	.word 771, 16383, 65511, 65535, 65535, 65535, 65409, 65534, 51327, 7951, 65407, 61439, 65532, 64685, 109, 
	.word 519, 65535, 65505, 65535, 65535, 65535, 65283, 65278, 46142, 799, 65535, 65535, 65530, 65194, 175, 
	.word 259, 65535, 65505, 65535, 65535, 65535, 65287, 65532, 55358, 30, 65535, 61375, 65530, 65205, 363, 
	.word 775, 65535, 65507, 65535, 65535, 65534, 65295, 65022, 24607, 15, 16383, 65471, 65530, 65198, 959, 
	.word 771, 65535, 65535, 65535, 65535, 65534, 65310, 65119, 47197, 15, 8191, 60351, 65530, 64725, 991, 
	.word 515, 65535, 65535, 65535, 65535, 65532, 65342, 65280, 40991, 7, 4095, 65279, 65522, 64683, 1916, 
	.word 3, 65535, 65535, 65535, 65535, 65528, 65403, 64000, 40982, 3, 2047, 63423, 65525, 64621, 4028, 

screen4:	
	.word 65535, 65535, 65533, 65535, 65535, 65279, 65535, 65535, 65535, 36835, 65417, 65287, 65503, 65535, 65279, 
	.word 65535, 65535, 65532, 65535, 65535, 65535, 65535, 60415, 65535, 40916, 65344, 65295, 65503, 65535, 64767, 
	.word 65535, 65535, 65533, 65535, 65535, 64511, 65535, 65535, 65535, 36677, 65296, 65343, 65471, 65535, 63999, 
	.word 65535, 65535, 65532, 65535, 65535, 64511, 65535, 64511, 65535, 36690, 65409, 65407, 65471, 65535, 62719, 
	.word 65535, 65535, 65532, 65407, 65535, 63487, 65535, 65535, 65532, 53034, 65363, 65535, 65535, 65535, 62207, 
	.word 65535, 65535, 65532, 65343, 65535, 65535, 65535, 65535, 65531, 53077, 65295, 65535, 65535, 65535, 59647, 
	.word 65535, 65535, 65532, 65535, 65535, 65535, 65535, 65535, 65533, 53077, 65407, 65535, 65535, 65535, 50431, 
	.word 65535, 65535, 65534, 65407, 65535, 65535, 65535, 65535, 65517, 53237, 65407, 65535, 65535, 65535, 57599, 
	.word 65535, 65535, 65534, 65343, 65535, 65535, 65535, 65535, 65495, 65389, 65535, 65535, 65535, 65535, 51455, 
	.word 65535, 65535, 65535, 65343, 65535, 65535, 65535, 65535, 65435, 65527, 65535, 65535, 65535, 65535, 49407, 
	.word 65535, 65535, 65535, 65343, 65535, 65535, 65535, 65534, 65471, 40874, 65535, 65535, 65535, 65535, 49407, 
	.word 65535, 65535, 65535, 65439, 65535, 65535, 65535, 65535, 65247, 24553, 65535, 65535, 65535, 65535, 49407, 
	.word 65535, 65535, 65535, 65423, 65535, 65535, 65535, 65535, 64639, 49028, 65535, 65535, 65535, 65535, 33023, 
	.word 65535, 65535, 65535, 65439, 65535, 65535, 65535, 65535, 65527, 32674, 65535, 65535, 65535, 65535, 33023, 
	.word 65535, 65535, 65535, 65439, 65535, 65535, 65535, 65533, 65534, 65280, 65407, 65535, 65535, 65535, 33023, 
	.word 65535, 65535, 65535, 65503, 16383, 65535, 65535, 65533, 65535, 65408, 65407, 65535, 65535, 65535, 255, 
	.word 61439, 65535, 65535, 65503, 32767, 65535, 65535, 65535, 65276, 65280, 65407, 65535, 65535, 65535, 33023, 
	.word 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65534, 65408, 65343, 65535, 65535, 65535, 255, 
	.word 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65503, 65533, 65312, 65343, 65535, 65535, 65535, 255, 
	.word 57343, 65535, 65535, 65535, 65535, 65535, 65535, 65519, 65517, 65408, 65407, 65535, 65535, 65535, 255, 
	.word 65535, 65535, 65535, 65535, 32767, 65535, 65535, 65503, 65531, 65360, 65407, 65535, 65535, 65535, 255, 
	.word 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65431, 65535, 65535, 65535, 65535, 255, 
	.word 65535, 65535, 65535, 65535, 65535, 65535, 65531, 65535, 65535, 65455, 65535, 65535, 65535, 65535, 255, 
	.word 65535, 65535, 65535, 65535, 65535, 65535, 65529, 65535, 65535, 65487, 65535, 65535, 65535, 65279, 255, 
	.word 65535, 65535, 65535, 65535, 65535, 65535, 65527, 65535, 65535, 65439, 65535, 65535, 65535, 65279, 255, 
	.word 65535, 65535, 65519, 65535, 65535, 65535, 65531, 65534, 65535, 49055, 65535, 65535, 65535, 65279, 255, 
	.word 65535, 65535, 65535, 65535, 65535, 65535, 65511, 65534, 65407, 3999, 65535, 65535, 65535, 65279, 1023, 
	.word 65535, 65535, 65531, 65535, 65535, 65535, 65503, 65534, 65535, 49567, 65535, 65535, 65535, 65279, 1023, 
	.word 65535, 65535, 65535, 65535, 65535, 65535, 65503, 65535, 65279, 9375, 32767, 65535, 65535, 65279, 2047, 
	.word 65503, 65535, 65535, 65535, 65535, 65535, 65471, 65535, 65535, 53279, 16383, 65535, 65535, 65279, 4095, 
	.word 65535, 65535, 65535, 65535, 65535, 65535, 65407, 65535, 65535, 20623, 4095, 65535, 65535, 65279, 4095, 
	.word 65247, 65535, 65535, 65535, 65535, 65534, 65535, 65535, 65535, 59535, 2047, 65535, 65535, 64767, 8190, 
	
END:
